 
Op Lock

useful to exploit TOCTOU bugs
	easily win a race against a process by locking a file or directory it tries to open.
 
 limitations: 
	-  you can't granularly “let through” just one access (all pending access will occur once the lock if lifted) 
	 - it does not work with all types of access, but it is usually very effective.

Exploit

The SetOpLock tool lets you create these and block access to a file or directory until you press enter to release the lock. It lets you choose between read, write and exclusive oplocks.

Again, James combined this technique with the previous ones to create a powerful primitive that eases the exploitation of some TOCTOU bugs: by setting up a pseudo-symlink (as before) and placing an oplock on the final file (target of the symlink), we can change the symlink when the target file is opened (even if the target file is locked, the symlink is not) and make it point to another target file:

![[Pasted image 20230515144058.png]]

On the setup shown above, the first access on the file C:\Dir\file.txt will open C:\One\foo.xxx, and the second access will open C:\Two\bar.yyy.

The BaitAndSwitch tool implements this technique with exclusive oplocks, if you need read or write locks you can use SetOpLock and CreateSymlink.


OpLocks only work on file streams, that is to say the file/directory must be opened with access rights which allow the access to the 
file's data stream.


