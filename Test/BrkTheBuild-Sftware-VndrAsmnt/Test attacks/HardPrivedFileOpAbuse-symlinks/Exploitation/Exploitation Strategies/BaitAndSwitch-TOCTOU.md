

Usage:

You specify a symbolic link path and two targets. Optionally, you can define what access types (read, write, delete) should trigger the OPLOCK notification.

This setup lets you control which file a process ends up accessing, even if the process thinks it's accessing another file. This is especially useful for security testing, where you might want to see if you can trick a system into executing or using a malicious file


BaitAndSwitch exploits the gap between the time a file is checked by a process (for example, a security check) and the time it is actually used. 

It leverages NTFS symbolic links and OPLOCKs (Opportunistic Locks) to intercept file access attempts and then quickly switches the target file or directory to something else.

Basic Operation:

Symbolic Links: Think of symbolic links (symlinks) like shortcuts or pointers to other files or directories. They direct access from one location to the original target location.

OPLOCKs: These are locks or notifications Windows uses to optimize file access. When a process tries to access a file that another process has locked using an OPLOCK, Windows notifies the locking process before proceeding. This gives the locking process a chance to react, like closing the file or changing it. Specific to file streams, meaning they trigger based on file access rights related to the file's data.

The Trick (TOCTOU): BaitAndSwitch sets an OPLOCK on a file that a symbolic link points to. When a process attempts to access this file, BaitAndSwitch receives a notification (thanks to the OPLOCK) and quickly switches the symbolic link to point to a different file. This swap happens after the security check but before the file is actually used, exploiting the TOCTOU gap.











Caveats:

Directory Restrictions: You can only create symlinks in empty directories due to junction point processing limitations.

nespace Limitations: Some calls might fail due to how the object manager nespace works, affecting how applications find and work with files.

Technical Limitations:

Symbolic links are 1. temporary and 2. rely on open handles.
1.
In Windows, particularly when you're creating symbolic links using certain tools or techniques, they can be created in a way that they exist only as long as they are being used or as long as the system session lasts. This is different from permanent symbolic links which would persist on the filesystem until explicitly removed. The temporary nature here implies that once the symbolic link is no longer in use or if the creating process ends, the symbolic link may automatically be removed or cease to exist.

2.
A "handle" in Windows is an identifier that is used by a program to keep track of resources like files, windows, or other system resources. When a symbolic link is described as "relying on open handles," it means that the existence or functionality of the symbolic link is tied to the handle of the process or file that created it or is using it. As long as the handle to the symbolic link (or the file/directory it points to) is open, the symbolic link is valid and functions as intended. Once all handles to the symbolic link are closed, especially in the context of these temporary symbolic links created for specific operations or security testing, the link might be automatically deleted or become non-functional.

If a process uses a symbolic link and holds an open handle to the target of the link, closing the process (e.g., closing the cmd where the process was run) would close the handle. This is because handles are tied to the lifecycle of the process. If the symbolic link's persistence is tied to an open handle (as with certain temporary symbolic links or when using specific functionalities), then closing the process would affect its availability. This scenario is more specific and not the general behavior of all symbolic links in the filesystem.


