# Planning and Considerations

## Preparing to develop malware

## Overview

Goals and objectives
Knowledge of the target
Requirements
Language considerations
Development environment
Collaboration and storage
Testing setup

## Goals and objectives 

- The malware should be designed to support the operator in achieving the objective of the campaign/mission
- This requires the malware author, operators and leads to coordinate before the development process
- Once the objectives have been established, the team can determine how the malware will support the goals and what role it will play
- Some areas may be common place, such as establishing communications with a command and control (C2) system and maintaining persistence access
- Others will be unique per objective:
    - Scraping memory for credit card information
     - Performing espionage against an individual
    - Simulating ransomware attacks

## Knowledge of the target

- Knowledge of the target’s security stack will increase the chance of success
- Open Source Intelligence (OSINT) gathering is helpful to identify items such as:
    - Endpoint protections (Anti-Virus / EDR)
    - Data Loss Prevention (DLP) solutions
    - Logging and Monitoring tools (Splunk)
    - Web Proxies
    - Operating System
    - Third party applications
- Beyond the technical components, it is helpful to understand the overall security maturity level (if possible) and general items such as the location, holiday schedules, culture, size of the company, etc. 

The knowledge gained from identifying the technical aspects will be essential to the success of the malware. 
- Identification of AV/EDR will allow for targeted evasion techniques
- Knowledge of DLP will help during exfiltration to ensure the data is not identified
- If applicable, the malware can target the logging and monitoring tools to find “blindspots” or develop capabilities to filter out events from the operators
- If a web proxy is in place, the infrastructure may be designed to allow C2 traffic that would otherwise be denied/prevented
- Identification of the operating systems will allow for the team to determine which ones may be targeted (e.g. the organization may not have a strong security stack on OSX vs Windows)
- Third party applications may be exploited to elevate privileges, establish persistent access, “blend” the malware in as part of the applications workflow, be used to process sensitive information, etc.

The overall security level / maturity of the target may drive items such as how much stealth is required, how quickly they may respond (e.g. outsourced Incident Response/Forensic processes vs in-house), if the security team is in house or if they are reactive or relying on a Managed Security Services Provider (MSSP), the overall skill level of the individuals responsible for security of the organization (rely on automated alerts vs. pro-active hunting, reverse engineer to find additional IOCs versus re-image and treat each system as an individual case). In most circumstances. 
!! The malware will only need to be just slightly better than the security posture of the target organization to accomplish the overall goal.!!

Knowledge of the target in general should also be considered. The malware may be developed to only be active during business hours, execute if a certain language/time zone is present or execute during a holiday.

## Requirements 

- The requirements may be provided by the larger team or defined by the authors
- For example, if the malware will be delivered through a social engineering campaign, it may need to be designed to operate or look in a certain manner to the end user
- Items may include:
    - Target operating systems
    - Security products that must be bypassed
    - Size constraints
    - How the malware will communicate with the C2 and when
    - How the operator will interact with the malware
    - Tactics, Techniques or Procedures (TTPs) or training objectives for the “blue” team
    - General operation security (in-memory versus dropping files to disk)

## Language considerations 

- The language for development should be driven by the requirements and knowledge of the target
- Considerations:
    - Installed by default (.NET, PowerShell, javascript, bash)
    - Interpreter/wrapper required (py2exe)
    - Difficulty to reverse engineer / decompile (C# vs C/C++)
    - Logging and defensive capabilities (AMSI, script block logging, etc)
    - Security stack (e.g. does it support analysing go compiled binaries?)
    - Ability for the team to modify during the operation


## Development environment 

- Chose an integrated development environment (IDE)
- If working with a team, standardization on an IDE is recommended
- Examples:
    - Visual Studio
    - XCode
    - Eclipse
- Determine any styling guidelines used by the team
- Install helpful plugins if desired, but check if any data is being collected and disable all telemetry


## Collaboration and storage

- In order to facilitate code management and documentation, a software repository is often used
- From an operation security perspective, this should be a private instance on a private server with no telemetry data being sent to a third party
- Examples:
    - GitLab
    - Gitea
    - Gogs
    - Phabricator

## Testing setup

- Setup a testing environment that replicates the target as closely as possible
- This is a crucial step to ensure the malware functions as expected and the proper steps have been taken to avoid detection
- Ensure the environment is isolated
    - Install the target operating system and apply updates
    - Install and update the necessary software (AV/EDR, Sysmon, etc)
    - Block inbound/outbound traffic
    - Take a snapshot

## Testing setup

- It is also helpful to understand what “normal” looks like (process relationships, how often they run, what components are loaded)
    - Enable verbose logging as appropriate
    - Forward logs to a collector (e.g. Kibana)
-Determine what Indicators of Compromise (IOCs) / artifacts are created when the malware is tested
-Document the results (playbook for operators)
    - How the malware was executed
    - What the malware was tested against (OS version, software versions)
    - Detection / Evasion notes
    - IOCs created
    - Known issues