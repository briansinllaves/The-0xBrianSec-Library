# Environmental Keying and Guardrails

## Why use environment keying and guardrails


## Why use environment keying and guardrails

Environment keying and guardrails are techniques used by malware authors to ensure that their payloads only execute in specific, intended environments. This helps prevent accidental execution on unintended systems (such as researchers’ sandboxes or automated analysis environments) and reduces the risk of detection and analysis.

**Key reasons for using these techniques:**

- **Targeted attacks:** Limit malware execution to specific victims by checking for unique system attributes (e.g., domain name, hostname, username, MAC address).
- **Anti-analysis:** Prevent execution in virtual machines, sandboxes, or analysis labs by requiring certain environmental conditions to be met.
- **Operational security:** Reduce the chance of widespread detection if the malware is accidentally leaked or captured by security researchers.
- **Persistence and control:** Ensure that payloads only run on compromised systems, making it harder for defenders to replicate or analyze the attack outside the target environment.
- **Guardrails:** Act as safety checks, so the malware will not execute or will self-delete if it detects it is not running in the intended environment.

Common environmental checks include domain membership, computer name, user name, hardware IDs, file paths, running processes,



## DPAPI

- Used by the Invisimole group to prevent execution of payloads outside of the compromised system
- Data Protection API (DPAPI) exposes two functions:
    - CryptProtectData which performs encryption on a DATA\_BLOB structure
    - CryptUnprotectData
- Uses the logon credentials of the local machine or user, depending on the flags specified, to encrypt the data
- Makes decryption outside of the compromised machine difficult as it requires knowledge of the machine/user credentials
-Disadvantage is the requirement to perform the encryption on the compromised host or the compromise of the DPAPI key (see mimikatz)

DPAPI is used by Windows to protect WIFI credentials, in the remote desktop connection manager, and other areas. It has been used by third parties such as Chrome to protect cookies.

## DPAPI Encryption Example

![Slide Image](../../assets/Environmental_Keying_and_Guardrails_images/slide5_img2.png)

## DPAPI Decryption Example

![Slide Image](../../assets/Environmental_Keying_and_Guardrails_images/slide6_img2.png)

## DPAPI Example 

The hostname of the system is retrieved, dpapi encrypted, and the result is used later as a decryption key in a separate encryption algorithm. 

The screenshot on the left show the hostname being DPAPI encrypted and the screenshot on the right shows the decryption result

![Slide Image](../../assets/Environmental_Keying_and_Guardrails_images/slide7_img1.png)

![Slide Image](../../assets/Environmental_Keying_and_Guardrails_images/slide7_img2.png)

## Common Guardrails

Malware often uses a variety of environmental checks—known as "guardrails"—to restrict execution to specific targets or environments. These checks help ensure the payload only runs on intended systems and avoids detection or analysis in sandboxes and research labs.

**Common guardrails include:**

- **Domain membership:** Only execute if the system is joined to a specific Active Directory domain.
- **Computer name:** Check for a particular hostname or naming pattern.
- **Username:** Restrict execution to specific user accounts.
- **MAC address:** Validate against a list of allowed network interface MAC addresses.
- **File paths/processes:** Look for the presence or absence of certain files or running processes (e.g., security tools, analysis software).

**Other advanced guardrails:**

- **MBR (Master Boot Record):** Check for unique or expected MBR values.
- **Hardware Profile GUID:** Validate the system’s hardware profile globally unique identifier.
- **Machine GUID:** Use the unique identifier assigned to the Windows installation.
- **SUS Client ID:** Check the Windows Update client identifier.
- **System SKU:** Validate the system’s stock-keeping unit (SKU) for hardware targeting.
- **ETag:** Use HTTP ETag headers to fingerprint or restrict payload delivery.

By combining multiple guardrails, attackers can make their malware highly targeted and resilient against analysis