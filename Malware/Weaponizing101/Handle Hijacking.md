# Handle Hijacking

## Slide 1

Handle Hijacking

## Slide 2

Common Process Flow for Dumping LSASS

AdjustTokenPrivilege for SE\_DEBUG
OpenProcess to get a handle to lsass
CreateFile to specify the location/name
MiniDumpWriteDump to write the contents to file
Detection:
Granted access with values 0x1010 (Mimikatz default) or 0x1410
0x1010 = VM\_READ | PROCESS\_QUERY\_LIMITED\_INFORMATION
0x1410 = VM\_READ | PROCESS\_QUERY\_LIMITED\_INFORMATION| PROCESS\_QUERY\_INFORMATION

![Slide Image](../../assets/Handle_Hijacking_images/slide2_img2.png)

![Slide Image](../../assets/Handle_Hijacking_images/slide2_img3.png)

## Slide 3

Microsoft Defender for Endpoint

Attack Surface Reduction (ASR) rule for MDE

![Slide Image](../../assets/Handle_Hijacking_images/slide3_img2.png)

## Slide 4

Handles

Per MSDN:
An object is a data structure that represents a system resource such as a file, thread, or graphic image
Objects cannot be directly accessed, instead an application must obtain a handle which can be used to examine or modify the object
Handles are stored in an internal table where the entries point to the address of the resource
Handles and objects are used to regulate access to resources
Handle APIs: CloseHandle, CompareObjectHandles, DuplicateHandle, GetHandleInformation, SetHandleInformation

## Slide 5

Locating Handles

Process Explorer from Sysinternals can be used to quickly locate handles
May be done programmatically using NtQuerySystemInformation

![Slide Image](../../assets/Handle_Hijacking_images/slide5_img2.png)

## Slide 6

Handle Hijacking Overview

Find a process (victim) with a handle to the process we want to target (e.g. lsass)
OpenProcess on the victim with PROCESS\_QUERY\_INFORMATION | PROCESS\_DUP\_HANDLE permissions
NtQueryInformationProcess to search for process handles
DuplicateHandle then get the process name using QueryFullProcessImageName
If the process name is the target process (e.g. lsass) return the handle, otherwise close the handle and continue
Use the returned handle as normal

## Slide 7

Handle Hijacking Overview (Continued)

Pros:
No call to OpenProcess which bypasses the MDE ASR rule
Technique can be used to access processes that are otherwise “restricted”
Cons:
Useable handles are likely specific to the target environment
Additional “actions” may still be from an unknown/untrusted process when leveraging the duplicated handle

## Slide 8

Future Improvements (lsass / MDE specific) 

MDE tracks “known” processes interacting with lsass
Inject into victim process that contains a handle to lsass and leverage the existing handle to dump memory
Known/expected process which may increase the chance of remaining undetected or is likely whitelisted

![Slide Image](../../assets/Handle_Hijacking_images/slide8_img2.png)

