# AV_EDR Evasion

## Agenda

Bypassing traditional AV
- Windows Defender bypasses
Bypassing EDR
- Cylance bypasses

## Understanding the Enemy

- Minifilter / kernel driver to intercept calls from userland to kernel mode
= Process monitoring - PsSetCreateProcessNotifyRoutineEx
- Thread monitoring - PsSetCreateThreadNotifyRoutine
- File type - PsSetLoadImageNotifyRoutine
- File Scanning - registers a minifilter for callbacks on R/RW operations on the filesystem
- Registry - CmRegisterCallback


AV Analysis Engine
- Unpackers
- Signature scanning
- Sandbox
- Heuristics

EDR
- Behavioral monitoring (commonly a DLL)


## Self Protection Mechanisms

- Protection from the user/malware stopping, disabling or tampering with components

- Minifilter to prevent changes to core components on the file system and registry

- ACLs / ObRegisterCallbacks to protect the service

- The ProcessNotifyRoutine is often used to gather details and assign a level of trust to the process if it is the AV/EDRs own whitelisted process

## Traditional AV Bypasses

Signatures
- Find the exact byte by splitting the file into small chunks and scanning

- Once the signature is found, modify, obfuscate, or encrypt the section of code

Scanning
- Inflate the file size
- Identify excluded process names and folders
- This information can often be found in the registry, GPOs, querying WMI or in memory

There is often a limit to the file size in order to prevent a performance hit for the user when scanning

## Traditional AV Bypasses

- McAfee HKLM\SOFTWARE\Wow6432Node\McAfee\SystemCore\vscore\On Access Scanner\McShield\Configuration\Default
- Windows Defender via WMI


![Slide Image](../../assets/AV_EDR_Evasion_images/slide7_img2.png)



# Windows Defender Dynamic Emulation Bypasses

Windows Defender implements a Virtual File System in which it runs samples

The VFS is static and is often not reflective of the target
- World of Warcraft registry keys
- Empty Windows directories
- IRC related files on the filesystem

Check for the presence of these items and do nothing or a benign activity

References: https://i.blackhat.com/us-18/Thu-August-9/us-18-Bulazel-Windows-Offender-Reverse-Engineering-Windows-Defenders-Antivirus-Emulator.pdf

Defender as a use case here but this applies to several other products as well. 
Often, functions are not completely implemented or hardcoded to return a static value, which can be used to fingerprint or bypass the emulation engine. For example, the CIA documented that some engines would always return FLS_OUT_OF_INDEXES when the FlsAlloc function is called.  
Additionally, calling OpenProcess on the PID of 4 (System process from session 0) should fail but this was not properly implemented on a few engines and would return success.

Other historical bypasses:
- Network traffic - when attempting to download a non-existent file the engine would return something random. Likewise, hardcoded user agent strings or responses may be used

- Emulation - instructions which behave differently on an emulated CPU
- Timing - time skews or inconsistencies
- Environment - harcdoded strings, files/registry entries/processes not present on the target or missing from the emulation environment


## Windows Defender Dynamic Emulation Bypasses


![Slide Image](../../assets/AV_EDR_Evasion_images/slide9_img2.png)


- Alternatively, leverage environmental keying
- Information on tools, logs from admins, forum posts, email headers, etc. can all reveal information about the endpoint, domain or network
- Ensure your code will only be executed if those items are present
- The Gauss malware uses environmental variables and expected system configurations as the decryption key, which to this day has not been broken

![Slide Image](../../assets/AV_EDR_Evasion_images/slide10_img2.png)


## Windows Defender Timing

- Tradeoff on how long AV can dedicate to analysis versus executing the program
- Use this to our advantage to create a delay that bypasses the heuristic engine
-Time delays are often emulated so need to perform an action that cannot be “speed up”
- Examples: allocate memory, hashing a string, math computations

## Windows Defender Timing

- Allocating and deallocating memory to create a delay
- Note the sleep statement to prevent 100% CPU usage
```
auto AllocateMemory()
{
    for (int i = 0; i < 50; i = i + 1)
    {
        char\* Memdmp = NULL;
        Memdmp = (char\*)malloc(110000000);
        if (Memdmp != NULL) {
            memset(Memdmp, 00, 110000000);
            free(Memdmp);
    }
        Sleep(150); // try and prevent high CPU usage
    }
}
```

# Cylance

AI-driven endpoint protection platform that relies heavily on machine learning models to detect and block threats, often before execution. Its capabilities include static analysis, memory protection, and behavioral monitoring.


**Common evasion techniques:**
- **Tampering with Cylance’s components:** Attackers may attempt to disable or modify Cylance services, drivers, or files. However, self-protection mechanisms and driver signing make this difficult.
- **Abusing intentional weaknesses:** Some malware targets known gaps or misconfigurations, such as exploiting exclusions or abusing trusted processes.
- **Unhooking specific functions:** Cylance hooks userland APIs to monitor and block malicious actions. Malware can attempt to unhook or restore original function prologues to bypass detection.
- **Mapping a clean DLL:** Known as "DLL hollowing" or "module stomping," this involves mapping a legitimate DLL into memory and replacing its code with malicious payloads, making detection harder.

**Optics vs. Memory Defense:**  
Cylance focuses on both file-based (optics) and memory-based (behavioral) detection. Evasion may require bypassing both static analysis (by obfuscating or encrypting payloads) and runtime monitoring (by hiding or masking malicious actions in memory).

**How it works:**  
Cylance uses AI models trained on large datasets to classify files and behaviors. It does not rely on traditional signatures, making it harder to evade with simple obfuscation. However, adversaries may use novel techniques or "living off the land" binaries (LOLBins) to blend in.

**AI Considerations:**  
Since Cylance’s detection is model-driven, attackers may test samples against the engine to identify features that trigger detection and iteratively modify their code. Adversarial machine learning techniques can also be used to generate files that evade AI-based classifiers.

### Kernel Callbacks

Kernel callbacks are used by security products to monitor system events (process/thread creation, image loading, registry changes, etc.).

- **Enumerating callbacks:** Attackers can enumerate registered kernel callbacks (e.g., via `PsSetCreateProcessNotifyRoutine`, `PsSetLoadImageNotifyRoutine`) to identify which drivers are monitoring the system.

- **Removing callbacks:** With sufficient privileges (often via a kernel exploit or vulnerable driver), malware can remove or unregister security product callbacks, effectively blinding the EDR/AV.
