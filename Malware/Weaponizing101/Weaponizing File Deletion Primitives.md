# Weaponizing File Deletion Primitives

## Overview

- Old method - patched
- Windows Error Reporting (WER)
- New method
- Microsoft Installer (MSI)

## Windows Error Reporting (WER)

![Slide Image](../../assets/Weaponizing_File_Deletion_Primitives_images/slide3_img2.png)

## Windows Error Reporting (WER) (primitive)

- Trigger file delete primitive to delete C:\ProgramData\Microsoft\Windows\WER under the context of system
- Create junction point from C:\ProgramData\Microsoft\Windows\WER to C:\Windows\System32\Wermgr.exe.local
- Run QueueReporting scheduled task under \Microsoft\Windows\Windows Error Reporting which in turn follow junction point and create C:\Windows\System32\Wermgr.exe.local under the context of system with write permissions for standard users
- Create WinSxS folder structure under C:\Windows\System32\Wermgr.exe.local and drop malicious Comctl32.dll
- All subsequent WER report submissions using scheduled tasks or by calling into APIs exposed by WER.dll will try to load WinSxS Comctl32.dll under the context of system
- Profit

## Microsoft Installer (MSI)

![Slide Image](../../assets/Weaponizing_File_Deletion_Primitives_images/slide5_img2.png)

![Slide Image](../../assets/Weaponizing_File_Deletion_Primitives_images/slide5_img3.png)

## Microsoft Installer (MSI) (primitive)

- Trigger file delete primitive to delete C:\Config.Msi under the context of system
- Create C:\Config.Msi and place an oplock on it
- Start MSI install that have two actions, that is short delay and throwing an error
- Once oplock is triggered, use file delete primitive to delete newly MSI created C:\Config.Msi again
- Create C:\Config.Msi (last time i promosie) and then replace legitimate rollback script .rbs file with malicious one ( TOCTOU)
- MSI installer will pick up malicious .rbs file during the rollback operation and ultimately execute rollback custom actions or move malicious DLL, etc. to system folder
- Profit!

## The ZeroDay

![Slide Image](../../assets/Weaponizing_File_Deletion_Primitives_images/slide7_img2.png)


![Slide Image](../../assets/Weaponizing_File_Deletion_Primitives_images/slide8_img2.png)



## Building the exploit

- Disclaimer: Most if not all of the code and notes are stolen, check last slide for links



## References.

- https://secret.club/2020/04/23/directory-deletion-shell.html
- https://www.zerodayinitiative.com/blog/2022/3/16/abusing-arbitrary-file-deletes-to-escalate-privilege-and-other-great-tricks
- https://www.cpuid.com/softwares/cpu-z.html
- https://github.com/MicrosoftDocs/win32/blob/docs/desktop-src/Msi/rollback-installation.md
- https://github.com/Wh04m1001/RazerEoP
- https://github.com/thezdi/PoC/tree/master/FilesystemEoPs

