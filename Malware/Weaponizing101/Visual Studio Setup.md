# Visual Studio Setup

## Slide 1

Visual Studio Setup

## Slide 2

Agenda

C++
Creating an executable
Creating a DLL
Recommended extensions
.NET
Common configuration options
Recommended extensions
Note, examples will be shown using Visual Studio 2019 running on Windows 10

## Slide 3

C++

## Slide 4

Creating a C++ project (executable)

A new C++ console can be created using the following steps:
Chose the option to create a new project
Change the language to C++ and select Console App
Select Next
Name your project and select the appropriate path to store the files

## Slide 5

Creating a C++ console application (executable)

![Slide Image](../../assets/Visual_Studio Setup_images/slide5_img1.png)

![Slide Image](../../assets/Visual_Studio Setup_images/slide5_img2.png)

## Slide 6

Configuring the project - C++ Language Standard

Configured by right clicking on the project, select properties, and setting the C++ Language Standard from General
Suggest setting to latest for all configurations and platforms

![Slide Image](../../assets/Visual_Studio Setup_images/slide6_img2.png)

## Slide 7

Code generation runtime library

Link with /MT when compiling for release.
Pro: Includes the run time library so you are not dependent on DLLs being present on the target system
Con: Increases the overall size of the executable

![Slide Image](../../assets/Visual_Studio Setup_images/slide7_img2.png)

## Slide 8

Optimizations

Tell the compiler to favor speed vs size
Will change between projects (e.g. may want to favor size when converting to shellcode or using as a payload for process hollowing)

![Slide Image](../../assets/Visual_Studio Setup_images/slide8_img2.png)

## Slide 9

Linker Inputs

Used to link against additional libraries not included by default (e.g. ntdll.lib)

![Slide Image](../../assets/Visual_Studio Setup_images/slide9_img2.png)

## Slide 10

Manifest File

Generation of the manifest file can be disabled in most cases to reduce size

![Slide Image](../../assets/Visual_Studio Setup_images/slide10_img2.png)

## Slide 11

Debugging - PDB Info

Will want to remove this for release versions most of the time
Contains path info (e.g. C:\Work\Keylogger\keylogger.pdb)
Can also modify for “false flags”

![Slide Image](../../assets/Visual_Studio Setup_images/slide11_img2.png)

## Slide 12

Build Events

Useful for automating items such as modification to code before compilation, naming compiled executables, moving to a file share on a test VM, etc

![Slide Image](../../assets/Visual_Studio Setup_images/slide12_img2.png)

## Slide 13

Using classes

Additional files can be added to the project to extend functionality
As an example, we will add the class to spawn a process with the parent process ID set to explorer and the mitigation to block the loading of non-Microsoft DLLs applied
Create a folder in your project named classes (optional)
Copy the SpawnProcessUnderExplorerBlockDlls.h file from the repo to the classes folder
Right click on the Header Files option in Solutions Explorer and select Add, then Existing Item. Select the SpawnProcessUnderExplorerBlockDlls.h file 

## Slide 14

Adding a class file

![Slide Image](../../assets/Visual_Studio Setup_images/slide14_img1.png)

![Slide Image](../../assets/Visual_Studio Setup_images/slide14_img2.png)

## Slide 15

Using the class

Include the file
Create a new instance of the class
Used the functions available in the class as normal
Note, if the class has other dependencies, these may need to be included as well or the code adjusted, such as the DebugPrint or CompileTimeXor class

![Slide Image](../../assets/Visual_Studio Setup_images/slide15_img2.png)

## Slide 16

Building 

Executables can be built using the Build option from the menu, or by using the shortcut CTRL + B
The Batch Build option can be used if you want to compile different version of the executable at once (e.g. x86 and x64)

## Slide 17

Creating a DLL

Select the Dynamic-Link Library option under Library to create a DLL project

![Slide Image](../../assets/Visual_Studio Setup_images/slide17_img2.png)

## Slide 18

Creating a DLL

Follow the same process to configure your project options as you did for an executable
DllMain.cpp will likely be the starting point for your code

![Slide Image](../../assets/Visual_Studio Setup_images/slide18_img2.png)

## Slide 19

Displaying Data 

Statements such as cout/wcout, printf, etc will not work in a DLL
Alternatively, we can use DebugView from Sysinternals to capture output
Call OutputDebugString with whatever you which to print
Example: OutputDebugString(L“DLL attached”);

![Slide Image](../../assets/Visual_Studio Setup_images/slide19_img2.png)

![Slide Image](../../assets/Visual_Studio Setup_images/slide19_img3.png)

## Slide 20

DllMain

DllMain contains DLL\_PROCESS\_ATTACH, DLL\_THREAD\_ATTACH, DLL\_THREAD\_DETACH and DLL\_PROCESS\_DETACH
DLL\_PROCESS\_ATTACH is called when the DLL is loaded into the process due to the process starting up or LoadLibrary being used
DLL\_PROCESS\_DETACH is called when the DLL is unloaded by the process or when the process terminates
DLL\_THREAD\_ATTACH is called when the process creates a new thread
DLL\_THREAD\_DETACH is called when a thread exits cleanly
Which one you use depends on how the DLL is utilized, but most often we use DLL\_PROCESS\_ATTACH

## Slide 21

DLL Caveats

MS recommends against performing multiple functions in DLL main for stability reasons
These include: loading libraries, creating processes, creating threads, initializing COM, calling registry functions and various others

## Slide 22

DLL Caveats

Create a new thread to run our function outside of DllMain
CreateThread(NULL, NULL, (LPTHREAD\_START\_ROUTINE)SomeFunction, NULL, NULL, NULL)
https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-best-practices

![Slide Image](../../assets/Visual_Studio Setup_images/slide22_img2.png)

## Slide 23

Creating Exported Functions

Common to need to create exported function in the DLL, especially for items such as DLL sideloading/hijacking
The \_\_declspec(dllexport) keyword can be used for this
Example of creating a “Start” exported function:
extern "C" \_\_declspec(dllexport) void \_\_cdecl Start();
\_\_declspec(dllexport) void \_\_cdecl Start()
{ OutputDebugString(L"In Start export"); }

## Slide 24

Creating Exported Functions

Calling the exported function directly

![Slide Image](../../assets/Visual_Studio Setup_images/slide24_img2.png)

## Slide 25

Building and Executing

Build the DLL in the same manner as an executable
To run the DLL directly: rundll32 demo.dll,Function
If you do not have an exported function, the command above will throw an error but it will still execute. However, our exported function was not executed

![Slide Image](../../assets/Visual_Studio Setup_images/slide25_img2.png)

![Slide Image](../../assets/Visual_Studio Setup_images/slide25_img3.png)

## Slide 26

Helpful C++ Extensions 

Extensions can be added through the VS marketplace
Select Extensions from the menu, then manage extensions
Popular extensions:
CodeMaid - automatic formatting of code. Supports various languages. Useful for removing extra spaces, indentations, etc. when sharing code with others
Open Command Line - adds an option to open cmd, powershell or the developer shell by right clicking within the solution
VSColorOutput - adds color to the build process to highlight warnings, errors, etc.

## Slide 27

.NET 

## Slide 28

Creating a .NET executable

