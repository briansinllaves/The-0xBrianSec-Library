# Time-of-Check Time-of-Use (TOCTOU)

## Description
TOCTOU is a race condition flaw where an attacker exploits the time gap between a system checking a resource’s state and then using it. For example, a privileged process checks permissions on a file and then opens it—but in between those steps, an attacker replaces the file with a malicious version using symlinks or renaming operations.

This is categorized under **MITRE ATT&CK T1499.004** (Exploitation for Privilege Escalation: Race Condition), **CWE-367** (TOCTOU Race Condition), and undermines **NIST SI-10** (Input Validation) and **AC-6** (Least Privilege).

## How to Identify
Use **Procmon** to trace file access patterns. Look for services or binaries that perform `QueryInformationFile` or `CreateFile` with gaps in between. Check for file operations occurring in user-writable directories like `%TEMP%`, `C:\Users\Public`.

TOCTOU is often discovered through manual code review, fuzzing, or timing-based testing. Race condition bugs require precise timing or symbolic link abuse, so dynamic analysis and race condition fuzzers (e.g., syzkaller) are essential.

## Defense Recommendations
Avoid splitting sensitive resource checks and operations. Use secure functions that validate access inline with the operation (e.g., open with flags like `O_EXCL`, `O_NOFOLLOW`).

Move security-sensitive file operations out of public directories. Validate and lock resources immediately before use. Ensure privilege separation between file creator and file consumer.

Monitor for abnormal symbolic link use or file access patterns in temp directories. Follow NIST SI-10 by validating resource states immediately prior to use and isolate race-prone logic in privileged code.

