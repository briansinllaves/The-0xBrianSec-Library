## Windows Privilege Escalation & Persistence Techniques

---

### **DLL Hijacking**

**Assumptions and Prereqs:**

* Application with SYSTEM-level privileges loads DLLs from insecure directories
* Attacker has **write access** to one or more of these directories

**Use Case and Situation:**
Used to gain persistence, privilege escalation, or code execution by dropping a malicious DLL in a directory searched by the application. The application unknowingly loads the attacker’s DLL, executing arbitrary code.

---

### **COM Hijacking**

**Assumptions and Prereqs:**

* **Write access** to `HKCU\Software\Classes`
* Knowledge of COM objects expected but missing from the environment
* Ability to create or modify `InprocServer32`, `TreatAs`, `CLSID`, and `ProgID` keys

**Use Case and Situation:**
Abuse of COM registration to hijack object resolution and execute attacker-controlled DLLs. Common for persistence or privilege escalation.

---

### **Named Pipes**

**Assumptions and Prereqs:**

* Local access with permission to create or interact with named pipes

**Use Case and Situation:**
Exploit improperly secured named pipes for impersonation, injection, or lateral movement. Often used in conjunction with RPC or service abuse to escalate privileges or exfiltrate data.

---

### **PrintNightmare (CVE-2021-34527)**

**Assumptions and Prereqs:**

* Print Spooler service running and vulnerable
* Ability to write/upload DLLs to the system

**Use Case and Situation:**
Exploit the Print Spooler to execute a malicious DLL as SYSTEM. Enables remote or local code execution with high integrity.

---

### **Potato Exploits (Rogue, Juicy, Rotten, etc.)**

**Assumptions and Prereqs:**

* SeImpersonatePrivilege or SeAssignPrimaryTokenPrivilege
* Typically granted to service accounts

**Use Case and Situation:**
Token relay attacks that result in SYSTEM-level shells.

* For Windows 10 1809+ or Server 2019+: use **RoguePotato**
* For older systems: use **JuicyPotato**

---

### **RPC Abuse**

**Assumptions and Prereqs:**

* Port 135 open
* Writable access to target RPC endpoints
* IDL definitions available

**Use Case and Situation:**
RPC can be used to trigger remote code execution or enumerate system/domain objects. Often paired with named pipes or COM.

---

### **OXID Resolver Exploitation**

**Assumptions and Prereqs:**

* OXID Resolver service running

**Use Case and Situation:**
Used for remote code execution or interface discovery. Can help identify other vulnerable DCOM endpoints.

---

## Privilege Escalation Techniques

---

### **AlwaysInstallElevated**

**Assumptions and Prereqs:**

* Registry keys set at:

  * `HKLM\Software\Policies\Microsoft\Windows\Installer`
  * `HKCU\Software\Policies\Microsoft\Windows\Installer`
    Both set to `1`
* Ability to run `.msi` files

**Use Case and Situation:**
Allows execution of malicious MSI packages with SYSTEM privileges.

---

### **Modifiable Scheduled Task File**

**Assumptions and Prereqs:**

* Task runs with elevated privileges
* Associated binary/script is stored in a user-writable path

**Use Case and Situation:**
Replace the file with a malicious binary. Task execution leads to SYSTEM-level code execution.

---

### **Modifiable Service Binaries**

**Assumptions and Prereqs:**

* Service binary located in a writable directory
* Service runs as SYSTEM

**Use Case and Situation:**
Replace the service binary and trigger a service restart to gain SYSTEM access.

---

### **Services with Modifiable Registry Keys**

**Assumptions and Prereqs:**

* User can modify keys under `HKLM\SYSTEM\CurrentControlSet\Services\[ServiceName]`

**Use Case and Situation:**
Point the `ImagePath` or other configuration values to a malicious executable. On service restart, it executes with elevated privileges.

---

### **Insecure Service Permissions / Modifiable binPath**

**Assumptions and Prereqs:**

* `sc qc` reveals the service has weak permissions
* Attacker can run `sc config` to modify the `binPath`

**Use Case and Situation:**
Change the `binPath` to execute an arbitrary payload as SYSTEM via service restart.

---

### **Registry AutoLogon**

**Assumptions and Prereqs:**

* AutoLogon enabled in `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`
* Attacker can read registry keys

**Use Case and Situation:**
Harvest cleartext credentials from registry for privilege escalation or lateral movement.

---

### **Saved Credentials (Credential Manager)**

**Assumptions and Prereqs:**

* Access to Credential Manager or other password stores
* Tools like Mimikatz or PowerShell available

**Use Case and Situation:**
Extract stored credentials for SYSTEM or domain accounts, aiding escalation or movement.

---

### **Modifiable Registry AutoRuns**

**Assumptions and Prereqs:**

* User can write to keys like `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
* Targets point to executables in writable paths

**Use Case and Situation:**
Persistence via AutoRun key injection. Executes attacker’s payload at user login.

---

### **Token Privileges**

**Assumptions and Prereqs:**

* Account has SeImpersonate or SeAssignPrimaryToken privilege
* Token abuse tools available

**Use Case and Situation:**
Spawn a high-privilege shell by impersonating another token. Often used in Potato-style attacks.

---

### **Services with Unquoted Paths**

**Assumptions and Prereqs:**

* Service path contains spaces and lacks quotes (e.g., `C:\Program Files\App\app.exe`)
* Attacker can write to intermediate directories

**Use Case and Situation:**
Place a malicious executable in an earlier path segment. Service starts it instead of the intended binary.

---

### **Startup Applications**

**Assumptions and Prereqs:**

* Startup entries reside in writable locations like:

  * `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
  * `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp`

**Use Case and Situation:**
Gain persistence by inserting a malicious script or binary. Common method is `.vbs` shortcut to a reverse shell.

---

### **Image Hijacks (IFEO Injection)**

**Assumptions and Prereqs:**

* Write access to `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options`

**Use Case and Situation:**
Set the `Debugger` value for a benign application (e.g., `notepad.exe`) to your payload path. When the app is launched, your payload executes.

---

### **Scheduled Task Abuse**

**Assumptions and Prereqs:**

* User can modify or create a scheduled task
* Task runs with elevated privileges

**Use Case and Situation:**
Replace or create a scheduled task to trigger your payload with high privileges.

---

## File Operation Vulnerabilities

---

### **Arbitrary File Delete / Write / Create**

**Assumptions and Prereqs:**

* High-privileged process interacts with attacker-controlled file/folder

**Use Case and Situation:**

* **Delete:** Remove critical files (e.g., `sam`, logs) to disrupt or hide activity
* **Write:** Overwrite files in privileged locations
* **Create:** Trigger DoS or persistence via malicious file creation

---
