# Named Pipe Enumeration and Exploitation

## Enumeration & Discovery

**Named Pipe Enumeration**  
Discover which named pipes are available on the target system using tools like Sysinternals' `pipelist` or `accesschk.exe -o \\.\pipe\*`.  

**Permission Check**  
Verify access permissions to determine if you can read from or write to the named pipe.  

**Service Interaction**  
Use documented commands or test inputs to interact with the named pipe server and observe responses.  

**Response Analysis**  
Analyze responses to understand what commands the pipe accepts and how the service behaves.  

**Weak Permissions**  
Identify pipes with weak ACLs allowing unauthorized access, which can lead to privilege escalation.  

**Anonymous Access**  
Look for named pipes that allow anonymous access, especially on high-value targets.  

**Sensitive Services**  
Focus on pipes like `\\.\pipe\spoolss`, `\\.\pipe\svcctl`, or `\\.\pipe\samr` linked to high-privilege services.  

**Privilege Escalation Potential**  
Check if impersonation or injection techniques are possible through the pipe.  

**Insecure Configurations**  
Audit pipes for insecure defaults or misconfigurations exploitable by local or remote users.  

**Information Leakage**  
Monitor for data leaks or metadata exposure through open or misused named pipes.  

**Unusual Activity**  
Watch for irregular or noisy pipe traffic as an indicator of exploitation or misconfiguration.  

---

## Basic Usage

Use `echo` to write to a named pipe and `type` to read from one in basic tests.

---

## Client Code to Send Command to Named Pipe (Python)

```python
import os

pipe_name = r'\\.\pipe\CommandPipe'

with open(pipe_name, 'w') as pipe:
    pipe.write('ipconfig\n')

with open(pipe_name, 'r') as pipe:
    output = pipe.read()
    print(f'Output: {output}')
```

---

## Creating a Custom Command Execution Service (C#)to accept NPCmd

```csharp
using System;
using System.IO;
using System.IO.Pipes;
using System.Diagnostics;
using System.Threading.Tasks;

public class NamedPipeCommandService
{
    public static void Main()
    {
        Task.Run(() => StartServer());
        Console.WriteLine("Named Pipe Command Execution Service Started.");
        Console.ReadLine(); // Keep main thread alive
    }

    private static void StartServer()
    {
        var server = new NamedPipeServerStream("CommandPipe", PipeDirection.InOut);
        server.WaitForConnection();

        using (var reader = new StreamReader(server))
        using (var writer = new StreamWriter(server))
        {
            string command = reader.ReadLine();
            string output = ExecuteCommand(command);
            writer.WriteLine(output);
            writer.Flush();
        }
    }

    private static string ExecuteCommand(string command)
    {
        var process = new Process
        {
            StartInfo = new ProcessStartInfo
            {
                FileName = "cmd.exe",
                Arguments = $"/c {command}",
                RedirectStandardOutput = true,
                UseShellExecute = false,
                CreateNoWindow = true,
            }
        };
        process.Start();
        return process.StandardOutput.ReadToEnd();
    }
}
```
