https://aquasecurity.github.io/kube-hunter/

https://github.com/aquasecurity/trivy
# Testing Container Images Off Production (Including Remote Testing)

## Overview
Testing container images off production helps ensure security and functionality without affecting live environments. This guide covers how to download, mount, test locally, and perform remote testing.

## Downloading Container Images

### Using Docker

#### Pull an Image
```sh
docker pull <image_ne>
```
Example:
```sh
docker pull nginx:latest
```

#### Save an Image to a Tar File
```sh
docker save -o <output_file.tar> <image_ne>
```
Example:
```sh
docker save -o nginx_latest.tar nginx:latest
```

### Using Podman (Alternative to Docker)

#### Pull an Image
```sh
podman pull <image_ne>
```
Example:
```sh
podman pull nginx:latest
```

#### Save an Image to a Tar File
```sh
podman save -o <output_file.tar> <image_ne>
```
Example:
```sh
podman save -o nginx_latest.tar nginx:latest
```

## Loading Container Images

### Using Docker

#### Load an Image from a Tar File
```sh
docker load -i <input_file.tar>
```
Example:
```sh
docker load -i nginx_latest.tar
```

### Using Podman

#### Load an Image from a Tar File
```sh
podman load -i <input_file.tar>
```
Example:
```sh
podman load -i nginx_latest.tar
```

## Running Container Images

### Using Docker

#### Run an Image
```sh
docker run -d --ne <container_ne> <image_ne>
```
Example:
```sh
docker run -d --ne nginx_test nginx:latest
```

### Using Podman

#### Run an Image
```sh
podman run -d --ne <container_ne> <image_ne>
```
Example:
```sh
podman run -d --ne nginx_test nginx:latest
```

## Mounting Volumes for Testing

### Using Docker

#### Mount a Volume
```sh
docker run -d --ne <container_ne> -v <host_path>:<container_path> <image_ne>
```
Example:
```sh
docker run -d --ne nginx_test -v /host/data:/container/data nginx:latest
```

### Using Podman

#### Mount a Volume
```sh
podman run -d --ne <container_ne> -v <host_path>:<container_path> <image_ne>
```
Example:
```sh
podman run -d --ne nginx_test -v /host/data:/container/data nginx:latest
```

## Testing with Trivy

### Scan a Docker Image
```sh
trivy image <image_ne>
```
Example:
```sh
trivy image nginx:latest
```

### Scan a Docker Image from a Tar File
```sh
trivy image --input <input_file.tar>
```
Example:
```sh
trivy image --input nginx_latest.tar
```

## Testing with Kube-hunter

### Remote Scanning
- Ensure the cluster IP or domain is securely accessible. Use secure channels (VPN, SSH tunneling) to connect if necessary.
```sh
kube-hunter --remote <cluster_ip_or_domain>
```
Example:
```sh
kube-hunter --remote 192.168.1.100
```

### In-cluster Scanning
- Deploy kube-hunter as a pod within the cluster.
```sh
kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-hunter/master/job.yaml
```

### Example of Remote Scanning via SSH Tunnel
1. **Create an SSH Tunnel**
```sh
ssh -L 8001:localhost:8001 user@remote-cluster
```

2. **Run kube-hunter through the Tunnel**
```sh
kube-hunter --remote localhost:8001
```

## Best Practices for Remote Testing
1. **Secure Connections**: Always use secure connections (VPN, SSH tunneling) for remote testing.
2. **Access Control**: Limit access to the remote cluster and use strong authentication mechanisms.
3. **Network Policies**: Implement network policies to restrict access to sensitive resources.
4. **Audit Logs**: Monitor and review audit logs for unauthorized access attempts.

## General Testing Tips
1. **Isolate Environment**: Always test in an isolated environment to avoid impacting production.
2. **Automate Scans**: Integrate Trivy and Kube-hunter scans into your CI/CD pipeline.
3. **Review Findings**: Regularly review scan reports and take action on identified vulnerabilities.
4. **Monitor Changes**: Keep track of changes in images and configurations to identify potential security risks.

